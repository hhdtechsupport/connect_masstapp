<?php
/**
 * @file
 * Custom Code for CAPTConnect.
 */

// OPEN CODE.
  global $conf;
  $conf['locale_custom_strings_en'][''] = array(
    'Your password has expired. You must change your password to proceed on the site.' =>
      variable_get('captconnect_custom_must_change_password',
      'In order to continue on this site, you need to change your password.'),
    'A welcome message with further instructions has been sent to your e-mail address.' =>
      variable_get('captconnect_custom_completion_email_sent',
      'An email has been sent with a link to complete the registration process.'),
    );

/**
 * Implements hook_permission().
 */
function captconnect_custom_permission() {
  $perms = array(
    'view registrations' => array(
      'title' => t('View Registrations'),
      'description' => t('View Registrations on Events.'),
      'restrict access' => FALSE,
      ),
    'register others' => array(
      'title' => t('Register Others'),
      'description' => t('Register another user.'),
      'restrict access' => FALSE,
      ),
    );
  return $perms;
}

/**
 * Implements hook_menu().
 */
function captconnect_custom_menu() {
  $items = array();

  $items['node/%node/notifications'] = array(
    'title' => 'Notifications',
    'page callback' => 'captconnect_custom_view_notifications',
    'page arguments' => array(1),
    'access callback' => 'captconnect_custom_access_notifications',
    'access arguments' => array(1),
    'weight' => 0,
    'type' => MENU_LOCAL_TASK,
    );

  $items['node/%node/registrations'] = array(
    'title' => 'Registrations',
    'page callback' => 'captconnect_custom_view_registrations',
    'page arguments' => array(1),
    'access callback' => 'captconnect_custom_access_registrations',
    'access arguments' => array(1),
    'weight' => 0,
    'type' => MENU_LOCAL_TASK,
    'file' => 'captconnect_custom.pages.inc',
    );

  $items['event/participate/%node/%user'] = array(
    'title' => 'Flag participation for someone else',
    'page callback' => 'captconnect_custom_participate_someone_else',
    'page arguments' => array(2, 3),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
    );

  $items['event/unregister/%node/%user'] = array(
    'title' => 'Unflag registration for someone else',
    'page callback' => 'captconnect_custom_unregister_someone_else',
    'page arguments' => array(2, 3),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
    );

  $items['admin/config/administration/captconnect'] = array(
    'title' => 'CAPT Connect',
    'description' => 'Various settings to control CAPT Connect custom functions',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('captconnect_custom_admin_settings'),
    'access arguments' => array('access administration pages'),
    'file' => 'captconnect_custom.admin.inc',
    );

  $items['admin/config/administration/captconnect/basic'] = array(
    'title' => 'Basic',
    'description' => 'Various settings to control CAPT Connect custom functions',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('captconnect_custom_admin_settings'),
    'access arguments' => array('access administration pages'),
    'file' => 'captconnect_custom.admin.inc',
    'type' => MENU_DEFAULT_LOCAL_TASK,
    );

  $items['admin/config/administration/captconnect/texts'] = array(
    'title' => 'Message Texts',
    'description' => 'Message texts for CAPT Connect custom functions',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('captconnect_custom_message_texts'),
    'access arguments' => array('access administration pages'),
    'file' => 'captconnect_custom.admin.inc',
    'type' => MENU_LOCAL_TASK,
    );

  $items['register_others'] = array(
    'title' => 'Register Another',
    'description' => 'Register on behalf of someone else.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('captconnect_custom_register_other'),
    'access arguments' => array('register others'),
    'type' => MENU_CALLBACK,
    );

  $items['participate_others'] = array(
    'title' => 'Participate Another',
    'description' => 'Participate on behalf of someone else.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('captconnect_custom_participate_other'),
    'access arguments' => array('register others'),
    'type' => MENU_CALLBACK,
    );

  $items['anon_login/%'] = array(
    'title' => 'Log In',
    'description' => 'Login then register.',
    'page callback' => 'captconnect_custom_anon_login',
    'page arguments' => array(1),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
    );

  $items['anon_register/%'] = array(
    'title' => 'Create a new account',
    'description' => 'Create user then register.',
    'page callback' => 'captconnect_custom_anon_register',
    'page arguments' => array(1),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
    );

  $items['administration/presenters'] = array(
    'title' => 'Presenters',
    'description' => 'List of Presenter Activity',
    'page callback' => 'captconnect_custom_presenter_list',
    'access arguments' => array('administer site configuration'),
    'type' => MENU_NORMAL_ITEM,
    'weight' => 50,
    'menu_name' => 'main-menu',
    'file' => 'captconnect_custom.pages.inc',
    );

  $items['nancy'] = array(
    'title' => 'Nancy',
    'description' => 'Stuff that needs a menu item',
    'page callback' => 'captconnect_custom_nancy',
    'access arguments' => array('administer site configuration'),
    'type' => MENU_CALLBACK,
    );

  return $items;
}

/**
 * Implements hook_theme().
 */
function captconnect_custom_theme() {
  return array(
    'captconnect_custom_admin_settings' => array(
       'render element' => 'form',
       'file' => 'captconnect_custom.admin.inc',
       ),
    'captconnect_custom_message_texts' => array(
       'render element' => 'form',
       'file' => 'captconnect_custom.admin.inc',
       ),
    'captconnect_custom_userprofile' => array(
       'render element' => 'elements',
       'template' => 'capt-user-profile',
       ),
    );
}

/**
 * Implements hook_menu_alter().
 */
function captconnect_custom_menu_alter(&$items) {
  $items['user']['title callback'] = 'captconnect_custom_user_page_title';

  // Change the permission on the "Manage display" tab.
  $items['user/%user/display']['access arguments'] = array('admin_display_suite');

  // Get rid of the User View tab.
  // Make user.view not a default tab.
  $items['user/%user/view']['type'] -= MENU_LINKS_TO_PARENT;
  // Make user.edit the default tab.
  $items['user/%user/edit']['type'] |= MENU_LINKS_TO_PARENT;

  // Try to hide "Log in" and "Request new password" tabs.
  $items['user/password']['type'] = MENU_CALLBACK;
  $items['user/login']['access callback'] = 'captconnect_custom_login_access';
}

/**
 * Implements hook_node_access().
 *
 * Exceptions to normal Drupal access rules.
 */
function captconnect_custom_node_access($node, $op, $account) {
  global $user;
  /*
  $who = (isset($account->uid) ? $account->uid : 'current');
  $what = (isset($node->nid) ? $node->nid : $node);
  drupal_set_message("captconnect_custom_node_access($what, $op, $who)"); /* */

  switch ($op) {
    case 'create':
      break;

    case 'view':
      // Node 931 is the core group, which we want to see the title of.
      // @TODO: do we need this in CAPTConnect?
      if (is_object($node) && $node->nid == 931) {
        return NODE_ACCESS_ALLOW;
      }
      break;

    case 'update':
      // Workflow Access grants access based on roles, but Events also need an OG check.
      $access_types = array('event');
      if (in_array($node->type, $access_types)) {
        $gid = field_get_items('node', $node, 'og_group_ref');

        // See if the user is a member of the node's group or core.
        if ($gid && og_is_member('node', array_pop(array_pop($gid)), 'user')) {
          // Yes, so just let other Drupal rules take over.
          return NODE_ACCESS_IGNORE;
        }
        else {
          // No, the current user does not match the viewed node's groups.
          return NODE_ACCESS_DENY;
        }
      }

      // Well, we've run out of exceptions, so Drupal can take it from here.
      break;

    case 'delete':
      return NODE_ACCESS_DENY;
  }

  return NODE_ACCESS_IGNORE;
}

/**
 * Menu access callback.
 * Decide whether or not to show the "Login" tabe.
 */
function captconnect_custom_login_access() {
  if ($_GET['q'] == 'user/register') {
    return FALSE;
  }

  // Menu administrators can see items for anonymous when administering.
  return !$GLOBALS ['user']->uid || !empty($GLOBALS ['menu_admin']);
}

/**
 * Menu access callback.
 * Decide whether or not to show the "Registrations" tab on Events.
 */
function captconnect_custom_access_registrations($node) {
  return ($node->type == 'event' && user_access('view registrations'));
}

/**
 * Menu access callback.
 * Decide whether or not to show the "Notifications" tab on Events.
 */
function captconnect_custom_access_notifications($node) {
  if ($node->type == 'event') {
    $notification = field_get_items('node', $node, 'field_related_notifications');
    if ($notification) {
      $notification = $notification[0]['target_id'];
      return node_access('update', node_load($notification));
    }
  }
  return FALSE;
}

/**
 * Menu callback.
 * Put the related Notifications into edit moode.
 */
function captconnect_custom_view_notifications($node) {
  if ($node->type == 'event') {
    $notification = field_get_items('node', $node, 'field_related_notifications');
    if ($notification) {
      $notification = array_pop(array_pop($notification));
      module_load_include('inc', 'node', 'node.pages');
      return node_page_edit(node_load($notification));
    }
  }
}

/**
 * User sort funtion for instances.
 */
function _captconnect_custom_sort_instances($a, $b) {
  // If the start times are the same, then we look at the end times.
  if ($a['start'] == $b['start']) {
    if ($a['end'] == $b['end']) {
      return 0;
    }
    else {
      return ($a['end'] < $b['end'] ? -1 : 1);
    }
  }
  else {
    return ($a['start'] < $b['start'] ? -1 : 1);
  }
}

/**
 * Particpate flag for someone else.
 */
function captconnect_custom_participate_someone_else($instance, $account) {
  $token = $_GET['token'];
  if ($token == flag_get_token($instance->nid)) {
    $part_flag = flag_get_flag('participate');
    $action = ($part_flag->is_flagged($instance->nid, $account->uid) ? 'unflag' : 'flag');

    if (!flag($action, 'participate', $instance->nid, $account)) {
      drupal_set_message(t('@name @action participation in "@title" failed,',
      array(
        '@name' => format_username($account),
        '@title' => $instance->label(),
        '@action' => $action,
        ), 'error'));
    }
  }
  else {
    drupal_set_message(t('Invalid token in link.'));
  }
  drupal_goto();
}

/**
 * Particpate flag for someone else.
 */
function captconnect_custom_unregister_someone_else($instance, $account) {
  $token = $_GET['token'];
  if ($token == flag_get_token($instance->nid)) {
    $part_flag = flag_get_flag('registrtation');

    if (!flag('unflag', 'registration', $instance->nid, $account)) {
      drupal_set_message(t('@name unregister in "@title" failed,',
      array(
        '@name' => format_username($account),
        '@title' => $instance->label(),
        '@action' => $action,
        ), 'error'));
    }
  }
  else {
    drupal_set_message(t('Invalid token in link.'));
  }
  drupal_goto();
}

/**
 * Menu title callback.
 * Various titles for the user page, depending on why we're here.
 */
function captconnect_custom_user_page_title() {
  global $user;
  if (user_is_logged_in()) {
    $title = t('My account');
  }
  else {
    $path = drupal_get_path_alias($_GET['q']);

    switch ($path) {
      case 'user/password':
        $title = t('Request new password');
        break;

      case 'user/register':
        $title = t('Create New Account');
        break;

      default:
        $title = t('Log in');
        break;
    }
  }
  return $title;
}

/**
 * Implements hook_module_implements_alter().
 * Make Node_Save_redirect last to run. See https://www.drupal.org/node/2476031.
 */
function captconnect_custom_module_implements_alter(&$implementations, $hook) {
  // Fire our form_alter last.
  if ($hook == 'form_alter' && isset($implementations['captconnect_custom'])) {
    $group = $implementations ['captconnect_custom'];
    unset($implementations['captconnect_custom']);
    $implementations['captconnect_custom'] = $group;
  }

  if ($hook == 'form_alter' && isset($implementations['node_save_redirect'])) {
    $group = $implementations ['node_save_redirect'];
    unset($implementations['node_save_redirect']);
    $implementations['node_save_redirect'] = $group;
  }

  // Make our hook_user_login() fire last so we can drupal_goto().
  if ($hook == 'user_login' && isset($implementations['captconnect_custom'])) {
//    $group = $implementations ['captconnect_custom'];
    $group = array('captconnect_custom' => $implementations['captconnect_custom']);
    unset($implementations['captconnect_custom']);
//    $implementations['captconnect_custom'] = $group;
    $implementations = $group + $implementations;
  }
}

/**
 * Implements hook_form_FORMID_alter().
 * Mess with the account edit form.
 */
function captconnect_custom_form_user_profile_form_alter(&$form, &$form_state, $form_id) {
//  dpm($form, $form_id);
  $form['actions']['#weight'] = 100;

  $form['account']['#weight'] = 0;

  if (isset($form['password_policy'])) {
    $form['password_policy']['#collapsible'] = TRUE;
    $form['password_policy']['#collapsed'] = TRUE;
    $form['password_policy']['#weight'] = 11;
  }

  if (isset($form['timezone'])) {
    // It is initially a fieldset, so let's just move the data up a level.
    $timezone = $form['timezone']['timezone'];
    unset($form['timezone']);
    $form['timezone'] = $timezone;
    $form['timezone']['#weight'] = 1;
  }

  if (isset($form['mimemail'])) {
    // It is initially a fieldset, so let's just move the data up a level.
    $mimemail = $form['mimemail']['mimemail_textonly'];
    unset($form['mimemail']);
    $form['mimemail'] = $mimemail;
    $form['mimemail']['#weight'] = 20;
  }
}

/**
 * Submit handler for requesting a new password.
 */
function captconnect_custom_request_password(&$form, &$form_state) {
  $form_state['redirect'] = 'user/password';
}

/**
 * Implements hook_form_alter().
 * Note: we need to be very late in the form cycle so we can see all the fields.
 */
function captconnect_custom_form_alter(&$form, &$form_state, $form_id) {
  global $user;
//  dpm($form, $form_id);
  switch ($form_id) {
    // Create a new account form.
    case 'user_register_form':
      // We sort of need to cheat.
      // We will override the multitab settings to become multipage.
      foreach ($form['#groups'] as $group_name => $stuff) {
        if ($group_name == 'group_tabs') {
          $form['#fieldgroups']['group_tabs']->format_type = 'multipage-group';
          $form['#fieldgroups']['group_tabs']->format_settings = array(
            'formatter' => '',
            'instance_settings' => array(
              'classes' => '',
              'page_header' => 1,
              'move_additional' => 1,
              'page_counter' => 1,
              'move_button' => 1,
              ),
            );
        }
        else {
          $groups[$group_name] = $stuff->label;
          $form['#fieldgroups'][$group_name]->format_type = 'multipage';
          $form['#fieldgroups'][$group_name]->format_settings = array(
            'formatter' => 'no-start',
            'instance_settings' => array(
              'description' => '',
              'classes' => '',
              'required_fields' => 1,
              ),
            );
        }
      }
      break;
      // Yes, there is no break, we want to fall through.

    case 'user_login':
      // User_login is normally the front page, so ignore that.
      if (!drupal_is_front_page()) {
        // We can get the instance nid from the original URI.
        $x = drupal_parse_url($_SERVER['REQUEST_URI']);
        $parts = explode('/', $x['path']);
        // It's $parts[2] because there is a leading slash.
        $form['#captconnect_anon_instance'] = $parts[2];
        $form_state['#captconnect_anon_instance'] = $parts[2];
      }

      $form['actions']['request_password'] = array(
       '#type' => 'submit',
       '#value' => variable_get('captconnect_custom_request_password_text',
         'Request a new password'),
        '#submit' => array('captconnect_custom_request_password'),
        '#weight' => 20,
        );

      $form['actions']['#weight'] = 100;

      break; /* */

    case 'user_pass_reset':
      // Borrowed and cleaned up from user.pages.inc.
      $timeout = variable_get('user_password_reset_timeout', 86400);
      $timestamp = arg(3);
      $form['message']['#markup'] = '';

      // Custom title?
      // @TODO: should this be in menu_alter()?
      drupal_set_title(variable_get('captconnect_custom_reset_pass_head',
        'Reset Password'));

      $account = user_load(arg(2));

      $result = db_query("SELECT ar.nid, di.entity_id "
        . "FROM {captconnect_custom_anon_register} ar "
        . "INNER JOIN {field_data_field_date_instance} di ON di.field_date_instance_target_id = ar.nid "
        . "WHERE ar.uid = :uid ",
        array(':uid' => $account->uid))->fetchAllKeyed();

      if ($result) {
        $event_nid = reset($result);
        $instance_nid = key($result);

        $event = node_load($event_nid);
        $instance = node_load($instance_nid);
        $form['message']['#markup'] .= '<p class="click-message">'
          . t(variable_get('captconnect_custom_reset_pass_welcome',
              'Click on this button to log in to the site and change your password. '
              . 'This will also complete your registration for "@event" on @instance.'),
            array(
              '@event' => $event->title,
              '@instance' => $instance->title,
              ))
          . '</p>';
      }
      else {
        $form['message']['#markup'] .= '<p class="click-message">'
          . t('Click on this button to log in to the site and change your password.')
          . '</p>';
      }

      $form['message']['#markup'] .= '<p class="one-time-message">'
        . t('This is a one-time login for %user_name and will expire on %expiration_date.',
          array(
            '%user_name' => $account->name,
            '%expiration_date' => format_date($timestamp + $timeout),
            ))
        . '</p>';
      break; /* */

    // Save the current path and grab the submit handler.
    case 'event_notifications_node_form':
      $form['#where_to'] = $_GET['q'];
      break; /* */
  }
//  dpm($form, $form_id);
}

/**
 * Implements hook_form_FORMID_alter().
 * Load node.pages.inc from Node module.
 */
function captconnect_custom_form_node_form_alter(&$form, &$form_state, $form_id) {
  form_load_include($form_state, 'inc', 'node', 'node.pages');
}

/**
 * Implements hook_form_FORM_ID_alter().
 * Put a class wrapper on the workflow_transition_form.
 * See https://www.drupal.org/node/2510958
 */
function captconnect_custom_form_workflow_transition_form_alter(&$form, &$form_state, $form_id) {
  $current_sid = $form['#default_value'];
  $current_state = workflow_state_load_single($current_sid);
  $class = drupal_html_class('state-' . ($current_state ? workflow_get_sid_label($current_sid) : 'unknown state'));
  $form['#attributes']['class'] = array('workflow-transition-form', $class);
}

/**
 * Implements hook_inline_entity_form_entity_form_alter().
 */
function captconnect_custom_inline_entity_form_entity_form_alter(&$entity_form, &$form_state) {
  if ($entity_form['#entity_type'] == 'notifications') {
    $form['field_related_event']['#access'] = FALSE;
    $form['field_related_event'][LANGUAGE_NONE]['#access'] = FALSE;
    // Load node.pages.inc from Node module.
    form_load_include($form_state, 'inc', 'node', 'node.pages');
  }
}

/**
 * Implements hook_inline_entity_form_table_fields_alter().
 */
function captconnect_custom_inline_entity_form_table_fields_alter(&$fields, $context) {
  // Make sure there's a stock field on each of the allowed types.
  $instances = FALSE;
  foreach ($context['allowed_bundles'] as $bundle) {
    if ($bundle == 'instance') {
      $instances = TRUE;
    }
  }
  $presenters = FALSE;
  foreach ($context['allowed_bundles'] as $bundle) {
    if ($bundle == 'presenter') {
      $presenters = TRUE;
    }
  }
  $materials = FALSE;
  foreach ($context['allowed_bundles'] as $bundle) {
    if ($bundle == 'material') {
      $materials = TRUE;
    }
  }
  $notifications = FALSE;
  foreach ($context['allowed_bundles'] as $bundle) {
    if ($bundle == 'notification') {
      $notifications = TRUE;
    }
  }

  // Replace fields shown for date instances
  if ($instances) {
    unset($fields['status']);
    $fields['field_max_registration'] = array(
      'type' => 'field',
      'label' => t('Max Registrations'),
      'weight' => 2
      );
  }

  // Replace fields shown for presenters
  if ($presenters) {
    unset($fields['status']);
    $fields['field_body'] = array(
      'type' => 'field',
      'label' => t('Presenter description'),
      'weight' => 2,
      'settings' => array(
        'trim_length' => 200
        )
      );
    $fields['field_presenter_image'] = array(
      'type' => 'field',
      'label' => t('Presenter image'),
      'weight' => 3,
      'settings' => array(
        'image_style' => 'thumbnail'
        )
      );
  }

  // Replace fields shown for date instances
  if ($materials) {
    unset($fields['status']);
    unset($fields['title']);
    $fields['field_source'] = array(
      'type' => 'field',
      'label' => t('Source'),
      'weight' => 2
      );
    $fields['field_resource'] = array(
      'type' => 'field',
      'label' => t('Resource'),
      'weight' => 3
      );
    $fields['field_material'] = array(
      'type' => 'field',
      'label' => t('Material'),
      'weight' => 4
      );
  }

  // Replace fields shown for notifications
  if ($notifications) {
    unset($fields['status']);
    unset($fields['title']);
    $fields['field_email_body'] = array(
      'type' => 'field',
      'label' => t('Body'),
      'weight' => 3
      );
  }
}

/**
 * Menu Callback.
 * Allow anonymous users to register for events.
 * @param $instance - nid of the instance node for which registration is desired.
 */
function captconnect_custom_anon_login($instance) {
  // Give them options.
  drupal_set_message(t(variable_get('captconnect_custom_anon_register',
      'If you do not have an account, please <a href="!create_url">create an account</a> to complete your registration.'),
    array('!create_url' => url('anon_register/' . arg(1),
    array('query' => drupal_get_destination())))),
    'status', FALSE);

  // So just redirect to the normal registration page.
  menu_execute_active_handler('user', TRUE);
}

/**
 * Menu Callback.
 * Allow anonymous users to register for events.
 * @param $instance - nid of the instance node for which registration is desired.
 */
function captconnect_custom_anon_register($instance) {
  // Give them options.
  drupal_set_message(t(variable_get('captconnect_custom_anon_login',
      'If you already have an account, please <a href="!login_url">Log In</a> to complete your registration.'),
    array('!login_url' => url('anon_login/' . arg(1),
    array('query' => drupal_get_destination())))),
    'status', FALSE);

  // So just redirect to the normal registration page.
  menu_execute_active_handler('user/register', TRUE);
}

/**
 * Submit handler for user registration.
 */
function captconnect_custom_user_register_submit($form, $form_state) {
  // Get the instance ID that they will register for when they come back.
  if (isset($form['#captconnect_anon_instance'])) {
    $register_nid = $form['#captconnect_anon_instance'];
    if ($register_nid) {
      $record = array(
        'uid' => $form['#user']->uid,
        'nid' => $register_nid,
        );
      $success = drupal_write_record('captconnect_custom_anon_register', $record);
    }

    // This is embarrassing, but I couldn't figure out any other way
    // to prevent that message from coming out a second time.
    $msgs = drupal_get_messages('status', TRUE);
    $get_rid_of = t(variable_get('captconnect_custom_anon_login',
      'If you already have an account, please <a href="!login_url">Log In</a> to complete your registration.'),
      array('!login_url' => url('anon_login/' . arg(1), array('query' => drupal_get_destination()))));
    foreach ($msgs['status'] as $msg) {
      if ($msg != $get_rid_of) {
        drupal_set_message($msg);
      }
    }
  }
}

/**
 * Implementation of hook_user_login().
 */
function captconnect_custom_user_login(&$edit, $account) {
  // Default redirect should be the front page.
  $edit['redirect'] = variable_get('captconnect_custom_login_dest', 'events');

  // Find out if the user is mid-registration (anon user).
  if (isset($edit['#captconnect_anon_instance'])) {
    // Got here from Login.
    // We can get the instance nid from the original URI.
    $x = drupal_parse_url($_SERVER['REQUEST_URI']);
    $result[$edit['#captconnect_anon_instance']] = substr($x['query']['destination'], 5);
  }
  else {
    // Got here from user register.
    $result = db_query("SELECT ar.nid, di.entity_id "
      . "FROM {captconnect_custom_anon_register} ar "
      . "INNER JOIN {field_data_field_date_instance} di ON di.field_date_instance_target_id = ar.nid "
      . "WHERE ar.uid = :uid ",
      array(':uid' => $account->uid))->fetchAllKeyed();
  }

  if ($result) {
    $event_nid = reset($result);
    $instance_nid = key($result);

    // Actually execute the flag before going to the event.
    $event = node_load($event_nid);
    $instance = node_load($instance_nid);
    if (flag('flag', 'registration', $instance_nid, $account)) {
      drupal_set_message(t(variable_get('captconnect_custom_registration_successful',
        'You are now registered for "@title" on @when.'),
        array('@title' => $event->title, '@when' => $instance->title)));
    }
    else {
      drupal_set_message(t(variable_get('captconnect_custom_registration_failed',
        'Your registration for "@title" failed; please try again now that you are logged in.'),
        array('@title' => $event->title)));
    }


    // Delete the record and then go to the event.
    $num_deleted = db_delete('captconnect_custom_anon_register')
      ->condition('uid', $account->uid)
      ->execute();

    // The redirect method is not working, so fall back on good ol' drupal_goto().
    $edit['redirect'] = 'node/' . $event_nid;
    $GLOBALS['destination'] = 'node/' . $event_nid;
  }
}

/**
 * Menu Callback.
 * Allow one user to register for someone else.
 */
function captconnect_custom_register_other($form, $form_state) {
  $dest = drupal_get_destination();
  list($x, $nid) = explode('/', $dest['destination']);
  $event = node_load($nid);
  $form['#event'] = $event;
  $form['#flag_action'] = variable_get('captconnect_custom_other_flag', 'registration');

  drupal_set_title(t('Register another person for "@event"', array('@event' => $event->title)), PASS_THROUGH);
  captconnect_custom_proxy_flag_form($event, $form);

  return $form;
}

/**
 * Menu Callback.
 * Allow one user to participate for someone else.
 */
function captconnect_custom_participate_other($form, $form_state) {
  $dest = drupal_get_destination();
  list($x, $nid) = explode('/', $dest['destination']);
  $event = node_load($nid);
  $form['#event'] = $event;
  $form['#flag_action'] = 'participate';

  drupal_set_title(t('Participate another person for "@event"', array('@event' => $event->title)), PASS_THROUGH);
  captconnect_custom_proxy_flag_form($event, $form);

  return $form;
}

/**
 * Helper form_builder for proxy regstration or participation.
 * @param $event - the event node object.
 * @param $form - the form array (by reference).
 */
function captconnect_custom_proxy_flag_form($event, &$form) {
  // Note, on entry $form['#flag_action'] is available.
  $reg_flag = flag_get_flag('registration');

  $instances = array();
  foreach (field_get_items('node', $event, 'field_date_instance') as $instance) {
    $instances[] = $instance['target_id'];
  }

  $form['#instances'] = entity_load('node', $instances);
  $instance_list = array();
  foreach ($form['#instances'] as $nid => $instance) {
    $instance_list[$nid] = $instance->title;

    // Is the instance full?
    if ($reg_flag->get_count($instance->nid) >= $instance->field_max_registration[LANGUAGE_NONE][0]['value']) {
      $instance_list[$nid] .= ' [' . t('full') . ']';
    }
    else {
      // Find first instance with capacity to be the default.
      if (!isset($default)) {
        $default = $instance->nid;
      }
    }
  }

  if (empty($instance_list)) {
    drupal_set_message(t('There are no instances available for which to register.'), 'warning');
    $instance_list[0] = t('* None *');
  }

	$form['account'] = array (
		'#type' => 'textfield',
		'#title' => t('Select the user'),
		'#autocomplete_path' => 'user/autocomplete',
  	);

  $form['which_one'] = array(
    '#type' => 'radios',
    '#options' => $instance_list,
    '#title' => t('Select a time for "%event"', array('%event' => $event->title)),
    '#default_value' => (isset($default) ? $default : key($instance_list)),
    );

  $form ['actions'] = array('#type' => 'actions', '#weight' => 100);
  $form ['actions']['submit'] = array('#type' => 'submit', '#value' => t('Save my choices'));
  $form ['actions']['cancel'] = array('#type' => 'submit', '#value' => t('Changed my mind'));

  $form['#validate'] = array('captconnect_custom_proxy_flag_form_validate');
  $form['#submit'] = array('captconnect_custom_proxy_flag_form_submit');
}

/**
 * Validation handler.
 */
function captconnect_custom_proxy_flag_form_validate($form, $form_state) {
  // Only check the fields if the "submit" button was clicked.
  if ($form_state['triggering_element']['#parents'][0] == 'submit') {
    if (empty($form_state['values']['account'])) {
      form_set_error('account', t('Please select an account name.'));
    }
    if (empty($form_state['values']['which_one'])) {
      form_set_error('which_one', t('Please select a time and date.'));
    }
  }
}

/**
 * Submit handler.
 */
function captconnect_custom_proxy_flag_form_submit($form, $form_state) {
  // Only process the data if the "submit" button was clicked.
  if ($form_state['triggering_element']['#parents'][0] == 'submit') {
    $flag_action = $form['#flag_action'];
    $flag = flag_get_flag($flag_action);
    $flag_title = $flag->title;

    $instance = $form['#instances'][$form_state['values']['which_one']];

    $account = user_load_by_name($form_state['values']['account']);

    // Set up arguments for messages.
    $args = array(
      '@event' => $form['#event']->title,
      '@user' => format_username($account),
      '@time' => $instance->title,
      '@action' => ($flag_action == 'registration' ? 'registrered for' : 'participating in'),
      );

    if ($flag->is_flagged($instance->nid, $account->uid)) {
      drupal_set_message(t('@user is already @action for this event.', $args));
      return;
    }

    // Okay, let's get 'er done.
    // The flag function returns a boolean to indicate success or failure.
    if (flag('flag', $flag_action, $instance->nid, $account)) {
      drupal_set_message(t(variable_get('captconnect_custom_proxy_registered',
        '@user is now @action "@event" at @time.'), $args));
    }
    else {
      drupal_set_message(t(variable_get('captconnect_custom_proxy_failed',
        'Flagging for @user for "@event" at @time failed.'), $args));
    }
  }
}

/**
 * Implements hook_flag_validate().
 * Make sure there's room in the event.
 */
function captconnect_custom_flag_validate($action, $flag, $entity_id, $account, $skip_permission_check, $flagging) {
  global $user;
  // Let's see if they are trying to register?
  if ($action == 'flag' && $flag->name == 'registration') {
    if ($user->uid == 3) {
      // Do my debugging here.
    }

    // Is the event instance at capacity yet?
    $instance = entity_metadata_wrapper('node', node_load($entity_id));
    $capacity = $instance->field_max_registration->value();
    if (empty($capacity)) {
      $capacity = 0;
    }

    // How many registrtations do we have currently?
    $num_regs = $flag->get_count($entity_id);
    if ($num_regs >= $capacity && $capacity > 0) {
      drupal_set_message('Yep, I did it.');
      return array('event-full' => t(variable_get('captconnect_custom_event_full',
        'We are sorry, but this event is full. You may try registering for another time or date.')));
    }
  }
}

/**
 * Implements hook_flag_link_type_info().
 */
function captconnect_custom_flag_link_type_info() {
  return array(
    'captconnect_custom' => array(
      'title' => t('CAPT Connect'),
      'description' => t('Additional CAPT logic on the flag.'),
      'options' => array(),
      'uses standard js' => TRUE,
      'uses standard css'=> TRUE,
      'provides form' => FALSE,
      ),
    );
} /* */

/**
 * Implements hook_flag_link().
 * ATM, this is just like the flag module.
 */
function captconnect_custom_flag_link($flag, $action, $entity_id) {
  $token = flag_get_token($entity_id);

  // Is the event instance at capacity yet?
  $instance = entity_metadata_wrapper('node', node_load($entity_id));
  $capacity = $instance->field_max_registration->value();
  if (empty($capacity)) {
    $capacity = 0;
  }

  // How many registrtations do we have currently?
  $num_regs = $flag->get_count($entity_id);

  // Are we at capacity, or are they already registered?
  if ($num_regs >= $capacity && $capacity > 0 && !$flag->is_flagged($entity_id)) {
    // This instance is full.
    return array(
      'title' => t('Full'),
      'attributes' => array('class' => array('instance-full')),
      );
  }
  else {
    // Not full, so give standard link.
    return array(
      'href' => 'flag/' . ($flag->link_type == 'confirm' ? 'confirm/' : '') . "$action/$flag->name/$entity_id",
      'query' => drupal_get_destination() + ($flag->link_type == 'confirm' ? array() : array('token' => $token)),
      );
  }

} /* */

/**
 * Implements hook_flag_anon_tokens_alter().
 * Add a token for our URL.
 * Requires local patch, see https://www.drupal.org/node/2527594.
 */
function captconnect_custom_flag_anon_tokens_alter(&$tokens, $link_options) {
  $tokens['[anon_register]'] = check_url(url('anon_register/' . $link_options['entity_id'], $link_options));
}

/*
 * Implements template_preprocess_node().
 * Add a class to the node so it can be displayed as published or not.
 */
function captconnect_custom_preprocess_node(&$variables) {
  $node = $variables ['node'];
  if (isset($node->field_workflow_state[LANGUAGE_NONE][0]['value'])) {
    $current_state = workflow_state_load_single($node->field_workflow_state[LANGUAGE_NONE][0]['value']);
    $class = ($current_state->name == 'published' ? 'published' : 'in-progress');
    $variables ['classes_array'][] = drupal_html_class('workflow-' . $class);
  }
}

/**
 * Implements hook_workflow().
 */
function captconnect_custom_workflow($op, $id, $new_sid, $entity, $force, $entity_type = '', $field_name = '', $transition = NULL, $user = NULL) {
  switch ($op) {
    case 'transition permitted':
      return ($id != $new_sid);
  }
}

/**
 * Implements hook_workflow_permitted_state_transitions_alter().
 */
function captconnect_custom_workflow_permitted_state_transitions_alter(array &$transitions, array $context) {
  // Remove any transition where the target state is the same as the current state.
  foreach ($transitions as $key => $transition) {
    if ($transition->sid == $transition->target_sid) {
      unset($transitions[$key]);
    }
  }
}

/**
 * Place to put special purpose stuff.
 */
function captconnect_custom_nancy() {
  global $user;
  $output = '';
  
  $flag = flag_get_flag('registration');
  $now = format_date(strtotime('0600', REQUEST_TIME), 'custom', 'Y-m-d h:i:s');
  $output .= '<p>Looking for stuff as of ' . $now . '.</p>';
  
  $query = db_select('node', 'n');
  $query->join('field_data_field_date', 'd', 'd.entity_id = n.nid');
  $query->join('field_data_field_related_events', 're', 're.entity_id = n.nid');
  $query->join('node', 'ren', 'ren.nid = re.field_related_events_target_id');
  $query->join('field_data_field_related_notifications', 'rn', 'rn.entity_id = re.field_related_events_target_id');
  $query->join('field_data_field_event_reminder', 'rm', 'rm.entity_id = rn.field_related_notifications_target_id');
  $query->join('field_data_field_days_before_event_to_send', 'be', 'be.entity_id = rm.field_event_reminder_target_id');
  $query->join('field_data_field_prevent_notification', 'pn', 'pn.entity_id = rm.field_event_reminder_target_id');
  $query->join('flagging', 'f', 'f.entity_id = n.nid');
  $query->join('users', 'u', 'u.uid = f.uid');
  $query->addField('n', 'nid', 'instance');
  $query->addField('ren', 'nid', 'event');
  $query->addField('ren', 'title');
  $query->addField('d', 'field_date_value', 'event_date');
  $query->addField('u', 'uid');
  $query->condition('n.status', 1);
  $query->condition('n.type', 'instance');
  $query->condition('d.field_date_value', $now, '>');
  $query->condition('pn.field_prevent_notification_value', 0);
  $query->condition('f.fid', $flag->fid);
  $query->where('be.field_days_before_event_to_send_value = DATEDIFF(d.field_date_value, :now)', array(':now' => $now));
  $result = $query->execute();
//  dpq($query);
  
  $rows = array();
  foreach ($result as $row) {
    $account = user_load($row->uid);
    $rows[] = array(
      l(drupal_get_path_alias("node/$row->instance"), "node/$row->instance"),
      l($row->title, "node/$row->event"),
      $row->event_date,
      l(format_username($account), "user/$row->uid"),
      );
  }
  $output .= theme('table', array('rows' => $rows));

  return $output;

  dpm($_GET, 'GET');
  dpm($_SERVER, 'SERVER');
  $x = drupal_parse_url($_SERVER['REQUEST_URI']);
  dpm($x, 'drupal_parse_url');
  dpm(explode('/', $x['path']), 'path parts');
  dpm(drupal_get_messages(NULL, FALSE), 'drupal_get_messages');
/*
  // Flush the schema cache.
  $schema = drupal_get_schema('captconnect_custom_anon_register', TRUE);
  if ($schema === FALSE) {
    $schema = 'Bah, humbug!';
  }
  $output .= '<pre>' . print_r($schema, TRUE) . '</p>';
/* */

  return $output;
}
