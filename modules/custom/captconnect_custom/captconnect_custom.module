<?php
/**
 * @file
 * Custom Code for CAPTConnect.
 */

/**
 * Implements hook_permission().
 */
function captconnect_custom_permission() {
  $perms = array(
    'view registrations' => array(
      'title' => t('View Registrations'),
      'description' => t('View Registrations on Events.'),
      'restrict access' => FALSE,
      ),
    'register others' => array(
      'title' => t('Register Others'),
      'description' => t('Register another user.'),
      'restrict access' => FALSE,
      ),
    );
  return $perms;
}

/**
 * Implements hook_menu().
 */
function captconnect_custom_menu() {
  $items = array();

  $items['node/%node/notifications'] = array(
    'title' => 'Notifications',
    'page callback' => 'captconnect_custom_view_notifications',
    'page arguments' => array(1),
    'access callback' => 'captconnect_custom_access_notifications',
    'access arguments' => array(1),
    'weight' => 0,
    'type' => MENU_LOCAL_TASK,
    );

  $items['node/%node/registrations'] = array(
    'title' => 'Registrations',
    'page callback' => 'captconnect_custom_view_registrations',
    'page arguments' => array(1),
    'access callback' => 'captconnect_custom_access_registrations',
    'access arguments' => array(1),
    'weight' => 0,
    'type' => MENU_LOCAL_TASK,
    );

  $items['admin/config/administration/captconnect'] = array(
    'title' => 'CAPT Connect',
    'description' => 'Various settings to control CAPT Connect custom functions',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('captconnect_custom_admin_settings'),
    'access arguments' => array('access administration pages'),
    'file' => 'captconnect_custom.admin.inc',
    'weight' => 2,
    'type' => MENU_NORMAL_ITEM,
    );

  $items['register_others'] = array(
    'title' => 'Register Another',
    'description' => 'Register on behalf of someone else.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('captconnect_custom_register_other'),
    'access arguments' => array('register others'),
    'type' => MENU_CALLBACK,
//    'type' => MENU_NORMAL_ITEM,
    );

  $items['anon_register'] = array(
    'title' => 'Anonymous Registration',
    'description' => 'Create user then register.',
    'page callback' => 'captconnect_custom_anon_register',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
    );

  $items['nancy'] = array(
    'title' => 'Nancy',
    'description' => 'Stuff that needs a menu item',
    'page callback' => 'captconnect_custom_nancy',
    'access arguments' => array('administer site configuration'),
    'type' => MENU_CALLBACK,
    );

  return $items;
}

/**
 * Implements hook_theme().
 */
function captconnect_custom_theme() {
  return array(
    'captconnect_custom_admin_settings' => array(
       'render element' => 'form',
       'file' => 'captconnect_custom.admin.inc',
       ),
    );
}

/**
 * Implements hook_menu_alter().
 */
function captconnect_custom_menu_alter(&$items) {
  $items['user']['title callback'] = 'captconnect_custom_user_page_title';

  // Get rid of the User View tab.
  // Make user.view not a default tab.
  $items['user/%user/view']['type'] -= MENU_LINKS_TO_PARENT;
  // Make user.edit the default tab.
  $items['user/%user/edit']['type'] |= MENU_LINKS_TO_PARENT;

  // Try to hide "Log in" and "Request new password" tabs.
  $items['user/password']['type'] = MENU_CALLBACK;
//  $items['user']['type'] = MENU_CALLBACK;
}

/**
 * Menu access callback.
 */
function captconnect_custom_access_registrations($node) {
  return ($node->type == 'event' && user_access('view registrations'));
}

/**
 * Menu access callback.
 */
function captconnect_custom_access_notifications($node) {
  if ($node->type == 'event') {
    $notification = field_get_items('node', $node, 'field_related_notifications');
    if ($notification) {
      $notification = $notification[0]['target_id'];
      return node_access('update', node_load($notification));
    }
  }
  return FALSE;
}

/**
 * Menu callback.
 */
function captconnect_custom_view_notifications($node) {
  if ($node->type == 'event') {
    $notification = field_get_items('node', $node, 'field_related_notifications');
    if ($notification) {
      $notification = array_pop(array_pop($notification));
      module_load_include('inc', 'node', 'node.pages');
      return node_page_edit(node_load($notification));
    }
  }
}

/**
 * Menu callback.
 */
function captconnect_custom_view_registrations($node) {
  global $user;
  if ($node->type == 'event') {
    drupal_set_title(t('Registrations for event "!title"', array('!title' => $node->title)));

    $css = '.no-registrations {text-align: center;}
      .instance-label {text-align: center; padding: 6px 0 3px 0; font-weight: bold; font-size: 120%; background-color: #ddffee;
        border-bottom: 2px solid #ff9900;}
      .instance-complete {font-size: 75%; color: #bb3333; font-style: italic;}
      .access-information {background-color: #ffff99;font-size: 89%;}
      .access-information p {margin: 0 2em;}
      #registrations-list a {color: inherit !important}
      #registrations-list tr.odd {background-color: #fff !important}
      #registrations-list tr {border-bottom: 0px;}';
    drupal_add_css($css, 'inline');

    $table = array(
      'rows' => array(),
      'header' => array(
        t('Registrant'),
        t('Registered'),
        t('Cancel Registration'),
        t('Participation'),
        ),
      'attributes' => array(
        'id' => 'registrations-list',
        ),
      'sticky' => TRUE,
      'empty' => t('There are currently no instances of this event.'),
      );
    $event = entity_metadata_wrapper('node', $node);

    // Query for registrations below.
    // @TODO: add "timestamp" column.
    $reg_query = "SELECT uid, timestamp FROM {flagging} "
      . "WHERE entity_id = :instance "
      . "AND fid = 2 "      // Registration.
      ;

    // Get all the instances.
    foreach ($event->field_date_instance->getIterator() as $instance) {
      $dates = $instance->field_date->value();
      // Is the event instance past?
      $instance_is_past = (strtotime($dates['value2'] . ' UTC') < REQUEST_TIME);

      if (user_access('edit any instance content')
      || (user_access('edit own instance content') && $instance->uid->value() == $user->uid)) {
        $title_link = l($instance->label(), 'node/' . $instance->nid->value() . '/edit',
          array('query' => drupal_get_destination()));
      }
      else {
        $title_link = $instance->label();
      }
<<<<<<< HEAD
      
      if ($instance_is_past) {
        $title_link .= ' <span class="instance-complete">' . t('Complete') . '</span>';
      }
      
=======

      if ($instance_is_past) {
        $title_link .= ' <span class="instance-complete">' . t('Complete') . '</span>';
      }

>>>>>>> nancy
      $table['rows'][] = array(array(
        'data' => $title_link,
        'colspan' => 20,
        'class' => array('instance-label'),
        ));

      // Get the event join link.
      // @TODO: Only show for a short time before the event?
      $link = $instance->field_link->value();

      // Get all the registration details.
      $rows = db_query($reg_query, array('instance' => $instance->nid->value()))->fetchAllKeyed();

      if (count($rows) > 0) {
        $users = entity_load('user', array_keys($rows));
        foreach ($users as $uid => $account) {
          $registrant = (user_access('administer users') ?
            l(format_username($account), "user/$account->uid/edit") : format_username($account));

          // @TODO: Time check.
          if ($instance_is_past) {
            $join = '';
          }
          else {
            if ($link['url']) {
              $join = l($link['title'], 'flag/flag/participate/' . $instance->nid->value(),
                array('query' => array(
                'destination' => $link['url'],
                'token' => flag_get_token($instance->nid->value()),   // Flag requires a token.
                )));
            }
            else {
              $join = t('See the access information.');
            }
          }

          $table['rows'][] = array(
            array('data' => $registrant, 'class' => array('registrant_name')),
            array('data' => format_date($rows[$uid]), 'class' => array('date_registered')),
            array('data' => l(t('Cancel'), 'flag/unflag/registration/' . $instance->nid->value()), 'class' => array('cancel_link')),
            array('data' => $join, 'class' => array('join_link')),
            );
        }
      }
      else {
        $table['rows'][] = array(array(
          'data' => t('There are no registrations for this instance yet.'),
          'colspan' => 20,
          'class' => array('no-registrations'),
          ));
      }
<<<<<<< HEAD
      
=======

>>>>>>> nancy
      // Display Access information.
      $text = $instance->field_access_information->value();
      if (!empty($text['value'])) {
        $table['rows'][] = array(array(
          'data' => check_markup($text['value'], $text['format']),
          'colspan' => 20,
          'class' => array('access-information'),
          ));
      }
    }

    if (user_access('register others') && variable_get('captconnect_custom_proxy_display', 'registration') == 'registration') {
      drupal_add_css('.register-others-button {color: white !important; border-radius: 15px !important;}', 'inline');
      $register_others = captconnect_custom_proxy_registration_button();
    }
    else {
      $register_others = NULL;
    }

    return theme('table', $table) . drupal_render($register_others);
  }
}

/**
 * Menu title callback.
 */
function captconnect_custom_user_page_title() {
  global $user;
  if (user_is_logged_in()) {
    $title = t('My account');
  }
  else {
    $path = drupal_get_path_alias($_GET['q']);

    switch ($path) {
      case 'user/password':
        $title = t('Request new password');
        break;

      case 'user/register':
        $title = t('User Registration');
        break;

      default:
        $title = t('Log in');
        break;
    }
  }
  return $title;
}

/**
 * Implements hook_module_implements_alter().
 */
function captconnect_custom_module_implements_alter(&$implementations, $hook) {
  if ($hook == 'admin_paths' && isset($implementations ['captconnect_custom'])) {
    $group = $implementations ['captconnect_custom'];
    unset($implementations ['captconnect_custom']);
    $implementations ['captconnect_custom'] = $group;
  }

  if ($hook == 'form_alter' && isset($implementations['node_save_redirect'])) {
    $group = $implementations ['node_save_redirect'];
    unset($implementations['node_save_redirect']);
    $implementations['node_save_redirect'] = $group;
  } /* */
}

/**
 * Implements hook_form_alter().
 */
function captconnect_custom_form_alter(&$form, &$form_state, $form_id) {
  switch ($form_id) {
    case 'user_profile_form':
      // This doesn't actually work.
      $form['#attributes'] = array('autocomplete' => 'off');
      break; /* */

    // Save the current path and grab the submit handler.
    case 'event_notifications_node_form':
      $form['#where_to'] = $_GET['q'];
      break; /* */
  }
//  dpm($form, $form_id);
}

/**
 * Implements hook_workflow().
 */
function captconnect_custom_workflow($op, $id, $new_sid, $entity, $force, $entity_type = '', $field_name = '', $transition = NULL, $user = NULL) {
  switch ($op) {
    case 'transition permitted':
      return ($id != $new_sid);
  }
}

/**
 * Implements hook_workflow_permitted_state_transitions_alter().
 */
function captconnect_custom_workflow_permitted_state_transitions_alter(array &$transitions, array $context) {
  // Remove any transition where the target state is the same as the current state.
  foreach ($transitions as $key => $transition) {
    if ($transition->sid == $transition->target_sid) {
      unset($transitions[$key]);
    }
  }
//  dpm($transitions, 'transitions');
//  dpm($context['state'], 'context[state]');
}

/**
 * Implements hook_username_alter().
 */
function captconnect_custom_username_alter(&$name, $account) {
  static $names = array();

  if (!is_object($account)) {
    return t('Invalid User');
  }

  // If the uid is 0 or not present, assume the user is anonymous.
  // Also, new users don't have a profile built yet, so just go away.
  if (empty($account->uid) || (isset($account->is_new) && $account->is_new)) {
    return variable_get('anonymous', t('Anonymous'));
  }

  if (isset($names[$account->uid])) {
    $name = $names[$account->uid];
    return;
  }

  // Get their first name. It will be FALSE if not given.
  $first = field_get_items('user', $account, 'field_first_name');
  if ($first) {
    $first = $first[0]['safe_value'];
  }
  else {
    $first = t('unknown');
  }
  // Likewise, the last name.
  $last = field_get_items('user', $account, 'field_last_name');
  if ($last) {
    $last = $last[0]['safe_value'];
  }
  else {
    $last = t('unknown');
  }

  // Save it and return.
  $name = $first . ' ' . $last;
  $names[$account->uid] = $name;
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function captconnect_custom_form_workflow_transition_form_alter(&$form, &$form_state, $form_id) {
  $current_sid = $form['#default_value'];

  // Hide button for current state.
//  $form['actions']['workflow_' . $current_sid]['#access'] = FALSE;
//  $form['actions']['workflow_' . $current_sid]['#disabled'] = TRUE;
//  unset($form['actions']['workflow_' . $current_sid]);

  // Put a class wrapper on the form.
  $current_state = workflow_state_load_single($current_sid);
  $class = drupal_html_class('state-' . ($current_state ? workflow_get_sid_label($current_sid) : 'unknown state'));
  $form['#attributes']['class'] = array('workflow-transition-form', $class);
//  dpm($form, $form_id . ' ' . $current_state->sid);
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function captconnect_custom_form_user_login_alter(&$form, &$form_state, $form_id) {
  $form['request'] = array(
    '#type' => 'markup',
    '#markup' => l(t(variable_get('request_password_text', 'Request a new password')),
      '/user/password',
      array('attributes' => array(
        'class' => array('request-password'),
        'title' => t('I forgot my password'),
        ))),
    );
}

function captconnect_custom_inline_entity_form_entity_form_alter(&$entity_form, &$form_state) {
  if ($entity_form['#entity_type'] == 'notifications') {
    $form['field_related_event']['#access'] = FALSE;
    $form['field_related_event'][LANGUAGE_NONE]['#access'] = FALSE;
  }
//  dpm($entity_form, 'captconnect_custom_inline_entity_form_entity_form_alter');
}

/**
 * Implements hook_inline_entity_form_table_fields_alter().
 */
function captconnect_custom_inline_entity_form_table_fields_alter(&$fields, $context) {
  // Make sure there's a stock field on each of the allowed types.
  $instances = FALSE;
  foreach ($context['allowed_bundles'] as $bundle) {
    if ($bundle == 'instance') {
      $instances = TRUE;
    }
  }
  $presenters = FALSE;
  foreach ($context['allowed_bundles'] as $bundle) {
    if ($bundle == 'presenter') {
      $presenters = TRUE;
    }
  }
  $materials = FALSE;
  foreach ($context['allowed_bundles'] as $bundle) {
    if ($bundle == 'material') {
      $materials = TRUE;
    }
  }
  $notifications = FALSE;
  foreach ($context['allowed_bundles'] as $bundle) {
    if ($bundle == 'notification') {
      $notifications = TRUE;
    }
  }

  // Replace fields shown for date instances
  if ($instances) {
    unset($fields['status']);
    $fields['field_max_registration'] = array(
      'type' => 'field',
      'label' => t('Max Registrations'),
      'weight' => 2
      );
  }

  // Replace fields shown for presenters
  if ($presenters) {
    unset($fields['status']);
    $fields['field_body'] = array(
      'type' => 'field',
      'label' => t('Presenter description'),
      'weight' => 2,
      'settings' => array(
        'trim_length' => 200
        )
      );
    $fields['field_presenter_image'] = array(
      'type' => 'field',
      'label' => t('Presenter image'),
      'weight' => 3,
      'settings' => array(
        'image_style' => 'thumbnail'
        )
      );
  }

  // Replace fields shown for date instances
  if ($materials) {
    unset($fields['status']);
    unset($fields['title']);
    $fields['field_source'] = array(
      'type' => 'field',
      'label' => t('Source'),
      'weight' => 2
      );
    $fields['field_resource'] = array(
      'type' => 'field',
      'label' => t('Resource'),
      'weight' => 3
      );
    $fields['field_material'] = array(
      'type' => 'field',
      'label' => t('Material'),
      'weight' => 4
      );
  }

  // Replace fields shown for notifications
  if ($notifications) {
    unset($fields['status']);
    unset($fields['title']);
    $fields['field_email_body'] = array(
      'type' => 'field',
      'label' => t('Body'),
      'weight' => 3
      );
  }
}

/**
 * Menu Callback.
 * Allow one user to register for someone else.
 */
function captconnect_custom_register_other($form, $form_state) {
  $dest = drupal_get_destination();
  list($x, $nid) = explode('/', $dest['destination']);
  $event = node_load($nid);
  $form['#event'] = $event;

  drupal_set_title(t('Register another person for "%event"', array('%event' => $event->title)), PASS_THROUGH);

  $instances = array();
  foreach (field_get_items('node', $event, 'field_date_instance') as $instance) {
    $instances[] = $instance['target_id'];
  }

  $form['#instances'] = entity_load('node', $instances);
  $instance_list = array();
  foreach ($form['#instances'] as $nid => $instance) {
    $instance_list[$nid] = $instance->title;
  }

	$form['account'] = array (
		'#type' => 'textfield',
		'#title' => t('Select the user'),
		'#required' => TRUE,
		'#autocomplete_path' => 'user/autocomplete',
  	);

  $form['which_one'] = array(
    '#type' => 'radios',
    '#options' => $instance_list,
    '#title' => t('Select a time for "%event"', array('%event' => $event->title)),
		'#required' => TRUE,
    );

  $form ['actions'] = array('#type' => 'actions', '#weight' => 100);
  $form ['actions']['submit'] = array('#type' => 'submit', '#value' => t('Save my choices'));
  $form ['actions']['cancel'] = array('#type' => 'submit', '#value' => t('Changed my mind'));

  return $form;
}

/**
 * Submit handler.
 */
function captconnect_custom_register_other_submit($form, $form_state) {
  $flags = flag_get_flags();

  $flag_action = variable_get('captconnect_custom_other_flag', 'registration');
  $flag_title = $flags[$flag_action]->title;

  $account = user_load_by_name($form_state['values']['account']);

  $instance = $form['#instances'][$form_state['values']['which_one']];

  // Okay, let's get 'er done.
  $args = array(
    '@event' => $form['#event']->title,
    '@user' => format_username($account),
    '@time' => $instance->title,
    );

  // The flag function returns a boolean to indicate success or failure.
  if (flag('flag', $flag_action, $instance->nid, $account)) {
    drupal_set_message(t('@user is now registrered for "@event" at @time.', $args));
  }
  else {
    drupal_set_message(t('Registration for @user for "@event" at @time failed.', $args));
  }
}

/**
 * Implements hook_node_view();
 */
function captconnect_custom_node_view($node, $view_mode, $langcode) {
  switch ($node->type) {
    case 'event':
      // May we add a proxy registration btton?
      if (user_access('register others') && variable_get('captconnect_custom_proxy_display', 'registration') == 'node') {
        drupal_add_css('.register-others-button {color: white !important; border-radius: 15px !important;float:right;}', 'inline');
        $node->content['register_others'] = captconnect_custom_proxy_registration_button();
      }
    break;
  }
}

/**
 * Helper to build the register button render array.
 */
function captconnect_custom_proxy_registration_button() {
  return array(
    '#theme' => 'link',
    '#text' => t('Register Someone Else'),
    '#path' => 'register_others',
    '#options' => array(
      'attributes' => array('class' => array('button', 'pretty-button', 'register-others-button')),
      'html' => FALSE,
      'query' => drupal_get_destination(),
      ),
    );
}

/**
 * Implements hook_field_extra_fields().
 */
function captconnect_custom_field_extra_fields() {
  $extra['node']['event'] = array(
    'display' => array(
      'register_others' => array(
        'label' => t("Register others button"),
        'description' => t('Allow registering someone else by proxy.'),
        'weight' => -99,   // Default to top.
        ),
      )
    );

  return $extra;
}

/**
 * Menu Callback.
 * Allow anonymous users to register for events.
 */
function captconnect_custom_anon_register() {
  $output = '';
  $dest = drupal_get_destination();

  $where = substr($dest['destination'], 5);
  $node = node_load($where);
  $output .= "<p>You want to register for '$node->title' ($where).</p>";

  $output .= '<p>' . t('Congratulations, you made it!') . '</p>';

  return $output;
}

/*
 * Implements hook_flag_anon_tokens_alter().
 * Add a token for our URL.
 */
function captconnect_custom_flag_anon_tokens_alter(&$tokens, $link_options) {
  $tokens['[anon_register]'] = check_url(url('anon_register', $link_options));
}

/*
 * Implements template_preprocess_node().
 * Add a class to the node so it can be displayed as published or not.
 */
function captconnect_custom_preprocess_node(&$variables) {
  $node = $variables ['node'];
  if (isset($node->field_workflow_state[LANGUAGE_NONE][0]['value'])) {
    $current_state = workflow_state_load_single($node->field_workflow_state[LANGUAGE_NONE][0]['value']);
    $class = ($current_state->name == 'published' ? 'published' : 'in-progress');
    $variables ['classes_array'][] = drupal_html_class('workflow-' . $class);
  }
}

function captconnect_custom_nancy() {
  global $user;
  $output = '';

  // Flush the schema cache.
  drupal_get_schema(NULL, TRUE);
  $output .= '<p>Schema cache cleared.</p>';

  return $output;
}
