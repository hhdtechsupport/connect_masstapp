<?php
/**
 * @file
 * Custom Code for CAPTConnect.
 */

/**
 * Implements hook_permission().
 */
function captconnect_custom_permission() {
  $perms = array(
    'view registration buttons' => array(
      'title' => t('View Registration Buttons'),
      'description' => t('View Registration buttons on Events.'),
      'restrict access' => FALSE,
      ),
    );
  return $perms;
}

/**
 * Implements hook_menu().
 */
function captconnect_custom_menu() {
  $items = array();

  $items['node/%node/notifications'] = array(
    'title' => 'Notifications',
    'page callback' => 'captconnect_custom_view_notifications',
    'page arguments' => array(1),
    'access callback' => 'captconnect_custom_access_notifications',
    'access arguments' => array(1),
    'weight' => 0,
    'type' => MENU_LOCAL_TASK,
    );

  $items['admin/config/administration/captconnect'] = array(
    'title' => 'CAPT Connect',
    'description' => 'Various settings to control CAPT Connect custom functions',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('captconnect_custom_admin_settings'),
    'access arguments' => array('access administration pages'),
    'file' => 'captconnect_custom.admin.inc',
    'weight' => 2,
    'type' => MENU_NORMAL_ITEM,
    );

  $items['nancy'] = array(
    'title' => 'Nancy',
    'description' => 'Stuff that needs a menu item',
    'page callback' => 'captconnect_custom_nancy',
    'access arguments' => array('administer site configuration'),
    'type' => MENU_CALLBACK,
    );

  return $items;
}

/**
 * Implements hook_menu_alter().
 */
function captconnect_custom_menu_alter(&$items) {
  $items['user']['title callback'] = 'captconnect_custom_user_page_title';
}

/**
 * Menu access callback.
 */
function captconnect_custom_access_notifications($node) {
  if ($node->type == 'event') {
    $notification = field_get_items('node', $node, 'field_related_notifications');
    if ($notification) {
      $notification = $notification[0]['target_id'];
      return node_access('view', node_load($notification));
//      return node_access('update', node_load($notification));
    }
  }
  return FALSE;
}

/**
 * Menu callback.
 */
function captconnect_custom_view_notifications($node) {
  if ($node->type == 'event') {
    $notification = field_get_items('node', $node, 'field_related_notifications');
    if ($notification) {
      $notification = array_pop(array_pop($notification));
//      return node_view(node_load($notification));
      module_load_include('inc', 'node', 'node.pages');
      return node_page_edit(node_load($notification));
    }
  }
}

/**
 * Menu title callback.
 */
function captconnect_custom_user_page_title() {
  global $user;
  if (user_is_logged_in()) {
    $title = t('My account');
  }
  else {
    $path = drupal_get_path_alias($_GET['q']);
    switch ($path) {
      case 'user/password':
        $title = variable_get('login_page_title','Request new password');
        break;

      case 'user/register':
        $title = variable_get('login_page_title','User Registration');
        break;

      default:
        $title = variable_get('login_page_title','Log in');
        break;
    }
  }
  return $title;
}

/**
 * Implements hook_module_implements_alter().
 */
function captconnect_custom_module_implements_alter(&$implementations, $hook) {
  if ($hook == 'admin_paths' && isset($implementations ['captconnect_custom'])) {
    $group = $implementations ['captconnect_custom'];
    unset($implementations ['captconnect_custom']);
    $implementations ['captconnect_custom'] = $group;
  }

  if ($hook == 'form_alter' && isset($implementations['captconnect_custom'])) {
    $group = $implementations ['captconnect_custom'];
    unset($implementations['captconnect_custom']);
    $implementations['captconnect_custom'] = $group;
  } /* */
}

/**
 * Implements hook_admin_paths().
 * Set all event_notifications paths to use Overlay.
 */
function xcaptconnect_custom_admin_paths() {
  // This query should be fairly quick unless theer are lots of notifications.
  // Note that the list is statically cached by path_get_admin_paths().
  $paths = db_query("SELECT CONCAT('node/', nid, '/edit'), 1 FROM {node} WHERE type = 'event_notifications'")->fetchAllKeyed();
  $paths['event/*/registrations'] = TRUE;
  $paths['node/*/registrations'] = TRUE;
  return $paths;
}

/**
 * Implements hook_admin_paths_alter().
 * Turn off Overlay on some standard pages.
 */
function xcaptconnect_custom_admin_paths_alter(&$paths) {
  $paths['user/*'] = FALSE;
  $paths['admin'] = FALSE;
  $paths['admin/modules'] = FALSE;
  $paths['admin/*'] = FALSE;
}

/**
 * Implements hook_form_alter().
 */
function captconnect_custom_form_alter(&$form, &$form_state, $form_id) {
  switch ($form_id) {
    case 'user_profile_form':
      $form['#attributes'] = array('autocomplete' => 'off');
  /*
//    case 'event_notifications_node_form':
    case 'notifications_node_form':
      $form['field_related_event']['#disabled'] = TRUE;
      $form['field_related_event'][LANGUAGE_NONE]['#disabled'] = TRUE;
      break; /* */
  }
//  dpm($form, $form_id);
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function captconnect_custom_form_user_login_alter(&$form, &$form_state, $form_id) {
  $form['request'] = array(
    '#type' => 'markup',
    '#markup' => l(t(variable_get('request_password_text', 'Request a new password')),
      '/user/password',
      array('attributes' => array(
        'class' => array('request-password'),
        'title' => t('I forgot my password'),
        ))),
    );

  if (module_exists('username_reminder')) {
    $form['reminder'] = array(
      '#type' => 'markup',
      '#markup' => '<br />' . l(t('Look up your username'),
        '/user/username',
        array('attributes' => array(
          'class' => array('request-password'),
          'title' => t('I forgot my user name'),
          ))),
      );
  }
}

function captconnect_custom_inline_entity_form_entity_form_alter(&$entity_form, &$form_state) {
  if ($entity_form['#entity_type'] == 'notifications') {
    $form['field_related_event']['#access'] = FALSE;
    $form['field_related_event'][LANGUAGE_NONE]['#access'] = FALSE;
  }
//  dpm($entity_form, 'captconnect_custom_inline_entity_form_entity_form_alter');
}

/**
 * Implements hook_inline_entity_form_table_fields_alter().
 */
function captconnect_custom_inline_entity_form_table_fields_alter(&$fields, $context) {
  // Make sure there's a stock field on each of the allowed types.
  $instances = FALSE;
  foreach ($context['allowed_bundles'] as $bundle) {
    if ($bundle == 'instance') {
      $instances = TRUE;
    }
  }
  $presenters = FALSE;
  foreach ($context['allowed_bundles'] as $bundle) {
    if ($bundle == 'presenter') {
      $presenters = TRUE;
    }
  }
  $materials = FALSE;
  foreach ($context['allowed_bundles'] as $bundle) {
    if ($bundle == 'material') {
      $materials = TRUE;
    }
  }
  $notifications = FALSE;
  foreach ($context['allowed_bundles'] as $bundle) {
    if ($bundle == 'notification') {
      $notifications = TRUE;
    }
  }

  // Replace fields shown for date instances
  if ($instances) {
    unset($fields['status']);
    $fields['field_max_registration'] = array(
      'type' => 'field',
      'label' => t('Max Registrations'),
      'weight' => 2
      );
  }

  // Replace fields shown for presenters
  if ($presenters) {
    unset($fields['status']);
    $fields['field_body'] = array(
      'type' => 'field',
      'label' => t('Presenter description'),
      'weight' => 2,
      'settings' => array(
        'trim_length' => 200
        )
      );
    $fields['field_presenter_image'] = array(
      'type' => 'field',
      'label' => t('Presenter image'),
      'weight' => 3,
      'settings' => array(
        'image_style' => 'thumbnail'
        )
      );
  }

  // Replace fields shown for date instances
  if ($materials) {
    unset($fields['status']);
    unset($fields['title']);
    $fields['field_source'] = array(
      'type' => 'field',
      'label' => t('Source'),
      'weight' => 2
      );
    $fields['field_resource'] = array(
      'type' => 'field',
      'label' => t('Resource'),
      'weight' => 3
      );
    $fields['field_material'] = array(
      'type' => 'field',
      'label' => t('Material'),
      'weight' => 4
      );
  }

  // Replace fields shown for notifications
  if($notifications) {
    unset($fields['status']);
    unset($fields['title']);
    $fields['field_email_body'] = array(
      'type' => 'field',
      'label' => t('Body'),
      'weight' => 3
      );
  }
}

/*
 * Implements template_preprocess_node().
 * Add a class to the node so it can be displayed as published or not.
 * Implements hook().
 */
function captconnect_custom_preprocess_node(&$variables) {
  $node = $variables ['node'];
  if (isset($node->field_workflow_state[LANGUAGE_NONE][0]['value'])) {
    $current_state = workflow_state_load_single($node->field_workflow_state[LANGUAGE_NONE][0]['value']);
    $class = ($current_state->name == 'published' ? 'published' : 'in-progress');
    $variables ['classes_array'][] = drupal_html_class('workflow-' . $class);
  }
}

function captconnect_custom_nancy() {
  global $user;
  // Flush the schema cache.
  drupal_get_schema(NULL, TRUE);

  
  $query = "SELECT n.nid FROM node n "
    . "LEFT JOIN field_data_field_workflow_state s ON s.revision_id = n.vid "
    . "WHERE n.type = 'event' AND n.status = 1 AND s.field_workflow_state_value IS NULL";
  $nids = db_query($query)->fetchCol();
  $nodes = entity_load('node', $nids);
  dpm($nodes, 'nodes');
  foreach ($nodes as $nid => $node) {
    $new_state = workflow_state_load_single(2);
    $options = $new_state->getOptions('node', $node, 'field_workflow_state', $user, FALSE);
    $transition = new WorkflowTransition();
    $transition->setValues('node', $node, 'field_workflow_state', 1, 2, $user->uid, REQUEST_TIME, 'assign initial');
    workflow_execute_transition('node', $node, 'field_workflow_state', $transition, FALSE);
//    end($nodes);
  }
  return "Event nodes changed";
  /* */
}
